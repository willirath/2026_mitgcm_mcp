# FESOM2 experiment tracking via the MCP tool

This document describes how an AI agent (or a user working with the MCP
server) should use the FESOM2 MCP tools to design, configure, and track a new
experiment from first principles. It also describes the conventions that keep
experiments reproducible and transferable.

The MCP tools are a knowledge layer over the FESOM2 source code and
documentation. They cannot run the model or write files — but they surface the
right parameter values, warn about known traps, and suggest configurations
that can be written directly into the experiment directory.

---

## Recommended workflow

### 1. Orient — find a starting configuration

Use `list_setups_tool` to discover pre-validated configurations:

```
list_setups_tool(names_only=True)
```

Pick the closest match and retrieve its full namelist content:

```
list_setups_tool(name="neverworld2", source="reference_namelist")
```

This returns every namelist group and parameter with inline comments. Use
this as the canonical starting point — do not invent parameter values.

### 2. Understand the domain — translate physical parameters

If you are designing a new domain (not a baked-in toy), translate physical
scales to model parameters before touching a namelist:

```
translate_lab_params_tool(Lx=..., Ly=..., depth=..., Omega=..., delta_T=...,
                          Nx=..., Ny=..., Nz=..., nu=..., kappa=..., alpha=...)
```

This returns suggested `step_per_day`, `K_hor`, `A_ver`, and `dt`. Then
validate the choices:

```
check_scales_tool(Lx=..., Ly=..., depth=..., Omega=..., delta_T=...,
                  dx=..., dy=..., dz=..., dt=..., U=...)
```

Read all flags in the result. A `"warning"` flag is a blocker; an `"info"`
flag is advisory.

### 3. Check for known gotchas

Before committing to a parameter set, search the gotcha catalogue:

```
lookup_gotcha_tool("toy ocean")
lookup_gotcha_tool("ALE linfs")
lookup_gotcha_tool("step_per_day")
lookup_gotcha_tool("namelist.forcing")
```

Key gotchas for toy experiments:

- `namelist.forcing` must exist even when `toy_ocean = .true.` — FESOM2
  opens it unconditionally at startup.
- `fesom.clock` must be written to `ResultPath` before the first run; a
  missing clock file causes a silent abort.
- Output frequency defaults to monthly (`'m'`); a 5-day run produces no
  output files unless the frequency is switched to `'d'`.
- `n_part` in `namelist.config` must exactly match the MPI rank count passed
  to `mpirun -np`. The partitioner (`fesom_ini.x`) must have been run for
  the same `n_part` before the model can start.
- `which_toy` selects a Fortran initial-state routine that may read
  additional files from `MeshPath` (e.g. `windstress.out` for neverworld2).
  The mesh must be geometrically consistent with the toy configuration.

### 4. Look up unfamiliar parameters

For any parameter whose meaning is unclear:

```
namelist_to_code_tool("surf_relax_t")   # returns file, line, description
search_docs_tool("GM eddy parameterisation")
search_code_tool("mix_scheme TOY")
```

Never guess a parameter value. Either find it in a reference setup, derive it
from `translate_lab_params_tool`, or look it up with the above tools.

### 5. Write the experiment directory

Once the parameter choices are settled, write all files into the experiment
directory following the three-layer structure described in
`docs/fesom2-experiment-defs.md`:

```
experiments/<name>/
├── mesh/
│   ├── create_mesh.py     documents how the mesh was produced
│   ├── nod2d.out
│   ├── elem2d.out
│   ├── aux3d.out
│   └── dist_N/            pre-computed or regenerated by fesom_ini.x
├── input/
│   └── namelist.*         all eight files, filled from MCP data
├── output/                gitignored
├── README.md
├── run.sh
└── plot.py
```

Every parameter value in `input/` should be traceable to one of: a
`list_setups_tool` result, a `translate_lab_params_tool` derivation, a
`check_scales_tool` validation, or an explicit citation in the README.

### 6. Document the experiment

Write a `README.md` in the experiment directory covering:

- **Motivation** — what physical question this experiment addresses
- **Physical setup** — domain size, rotation, stratification, forcing
- **Scale analysis** — paste the output of `check_scales_tool`
- **Parameter choices** — justify non-default values
- **Gotchas encountered** — document any issues found via `lookup_gotcha_tool`
- **Files** — a `tree`-style listing
- **How to run** — `pixi run` commands or direct docker invocation

The README should be self-contained. A reader with no access to the
conversation that created it should be able to understand every choice.

---

## What to commit

| Item | Commit? | Reason |
|---|---|---|
| `mesh/create_mesh.py` | yes | documents mesh provenance |
| `mesh/nod2d.out`, `elem2d.out`, `aux3d.out` | yes for small meshes (< ~50 MB) | portable geometry |
| `mesh/windstress.out` (or similar) | yes | part of experiment definition |
| `mesh/dist_N/` | yes for small meshes | avoids requiring partitioner at runtime |
| `input/namelist.*` | yes — all eight files | complete physics definition |
| `output/` | no | reproduced by running the model |
| `plot.py` | yes | analysis is part of the experiment |
| `*.png` (output figures) | yes | reference result; shows the model ran correctly |

For meshes too large to commit, add to `.gitignore`:

```gitignore
experiments/*/mesh/dist_*/
```

and document the regeneration command in `README.md`:

```bash
pixi run partition-<name>   # runs fesom_ini.x for the required n_part
```

---

## MCP tool reference for experiment design

| Task | Tool |
|---|---|
| Find a starting configuration | `list_setups_tool(names_only=True)` then `list_setups_tool(name=...)` |
| Translate physical parameters to model values | `translate_lab_params_tool(...)` |
| Validate time step and grid choices | `check_scales_tool(...)` |
| Look up a namelist parameter | `namelist_to_code_tool("param_name")` |
| Find documentation for a scheme or feature | `search_docs_tool("...")` |
| Search source code for behaviour | `search_code_tool("...")` |
| Check for known configuration traps | `lookup_gotcha_tool("topic")` |
| Get a skeleton namelist for an experiment class | `suggest_experiment_config_tool("baroclinic_channel")` |
| Understand a module's subroutines | `get_module_tool("module_name")` |
| Trace what a subroutine does | `get_source_tool("subroutine_name")` |

---

## Anti-patterns to avoid

- **Do not invent parameter values.** Always derive from `translate_lab_params_tool`
  or retrieve from `list_setups_tool`. Guessed values are the most common
  source of silent physics errors.
- **Do not omit any of the eight namelist files.** FESOM2 opens all of them
  at startup regardless of which components are active.
- **Do not set `MeshPath`, `ResultPath`, or `ClimateDataPath` in the tracked
  namelists** to machine-specific paths. Leave them empty (`''`); the Docker
  entrypoint patches them to container-internal paths at runtime. This is
  what makes the experiment transferable.
- **Do not commit `output/`.** Output files are large and fully reproduced by
  re-running the experiment. Commit only the reference figure (`*.png`).
- **Do not skip `check_scales_tool`.** A time step that passes the horizontal
  CFL can still fail the vertical CFL, particularly in experiments with strong
  convection or fine vertical resolution near the surface.
